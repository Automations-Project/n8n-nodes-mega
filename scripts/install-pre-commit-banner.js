/*
 * Install a Git pre-commit hook that updates the README banner (intro.png)
 * and stages it before each commit.
 *
 * Usage: npm run setup:banner-hook
 */

const fs = require('node:fs');
const path = require('node:path');

(function main() {
  try {
    const root = path.resolve(__dirname, '..');
    const gitDir = path.join(root, '.git');
    if (!fs.existsSync(gitDir)) {
      console.error('[setup:banner-hook] .git directory not found. Run inside a cloned Git repository.');
      process.exit(1);
    }

    const hooksDir = path.join(gitDir, 'hooks');
    if (!fs.existsSync(hooksDir)) fs.mkdirSync(hooksDir, { recursive: true });

    const hookPath = path.join(hooksDir, 'pre-commit');

    const hook = `#!/bin/sh
# Auto-generated by scripts/install-pre-commit-banner.js
# Updates README banner before commit and stages the image.

echo "[pre-commit] Updating README banner..."
# Use npm to ensure PATH/node_modules resolution
npm run --silent update:banner
status=$?
if [ $status -ne 0 ]; then
  echo "[pre-commit] Banner update failed; aborting commit."
  exit $status
fi

# Stage the updated banner file
if git rev-parse --git-dir > /dev/null 2>&1; then
  git add intro.png 2>/dev/null || true
fi

exit 0
`;

    fs.writeFileSync(hookPath, hook, { encoding: 'utf8' });
    try {
      fs.chmodSync(hookPath, 0o755);
    } catch (_) {}

    console.log('[setup:banner-hook] Installed pre-commit hook at .git/hooks/pre-commit');
  } catch (err) {
    console.error('[setup:banner-hook] Error:', err && err.message ? err.message : err);
    process.exit(1);
  }
})();
